# Talos Configuration

This directory contains the Talos Linux configuration for the Kubernetes cluster.

## Directory Structure

```
talos/
â”œâ”€â”€ talconfig.yaml              # Main configuration (nodes, network, patches)
â”œâ”€â”€ talenv.yaml                 # Version configuration (Talos & Kubernetes versions)
â”œâ”€â”€ talsecret.sops.yaml        # Encrypted secrets (SOPS)
â”œâ”€â”€ patches/                    # Configuration patches
â”‚   â”œâ”€â”€ global/                # Applied to all nodes
â”‚   â””â”€â”€ controller/            # Applied to control plane only
â”œâ”€â”€ clusterconfig/             # Generated machine configs (DO NOT EDIT MANUALLY)
â”œâ”€â”€ upgrade-talos.sh           # Automated upgrade script â­
â”œâ”€â”€ UPGRADE.md                 # Complete upgrade documentation ðŸ“–
â””â”€â”€ README.md                  # This file

```

## Quick Start

### Initial Setup

1. **Generate configurations**
   ```bash
   talhelper genconfig
   ```

2. **Apply to nodes**
   ```bash
   talosctl apply-config --nodes 192.168.10.33 --file clusterconfig/kubernetes-k8s-cp-1.yaml
   ```

### Upgrading Talos

See [UPGRADE.md](./UPGRADE.md) for complete documentation.

**Quick upgrade process:**
```bash
# 1. Update version
vim talenv.yaml

# 2. Regenerate configs
talhelper genconfig

# 3. Run automated upgrade
./upgrade-talos.sh
```

## Configuration Files

### talconfig.yaml

Main configuration file containing:
- Node definitions (hostnames, IPs, MACs)
- Network configuration
- Factory image URLs (schematics)
- Global and controller-specific patches

**Important**: Each node can have a different `talosImageURL` to use different extensions.

### talenv.yaml

Version configuration:
- `talosVersion` - Talos OS version
- `kubernetesVersion` - Kubernetes version

These are interpolated into `talconfig.yaml` using environment variable substitution.

### Patches

Patches are applied in this order:
1. Global patches (all nodes)
2. Controller patches (control plane only)

**Patch Format**: Use strategic merge patches (YAML) with `$$patch: delete` for deletions (note the double `$$` to escape talhelper's envsubst).

## Node Types & Schematics

This cluster uses different Talos factory images based on node type:

| Node Type | Nodes | Extensions |
|-----------|-------|-----------|
| VM Control Plane | k8s-cp-1, k8s-cp-2 | iscsi-tools + qemu-guest-agent |
| Physical Control Plane | k8s-cp-3 | iscsi-tools |
| Raspberry Pi Workers | k8s-pi-1 to k8s-pi-8 | iscsi-tools |

## Common Tasks

### Generate/Regenerate Configs

```bash
talhelper genconfig
```

This creates/updates all files in `clusterconfig/` based on `talconfig.yaml` and `talenv.yaml`.

### Apply Config Changes

```bash
# Single node
talosctl apply-config --nodes 192.168.10.33 --file clusterconfig/kubernetes-k8s-cp-1.yaml

# All nodes
for config in clusterconfig/kubernetes-k8s-*.yaml; do
  node=$(basename "$config" .yaml | sed 's/kubernetes-k8s-//')
  ip=$(yq eval ".nodes[] | select(.hostname == \"k8s-$node\") | .ipAddress" talconfig.yaml)
  talosctl apply-config --nodes "$ip" --file "$config"
done
```

### Upgrade Talos Version

See [UPGRADE.md](./UPGRADE.md) or use:
```bash
./upgrade-talos.sh
```

### Check Node Status

```bash
# Version
talosctl version --nodes 192.168.10.33

# Extensions
talosctl get extensions --nodes 192.168.10.33

# Services
talosctl services --nodes 192.168.10.33

# Logs
talosctl logs --nodes 192.168.10.33 kubelet
```

### Add New Extension

1. Create schematic with extensions:
   ```bash
   cat > extensions.yaml << 'EOF'
   customization:
     systemExtensions:
       officialExtensions:
         - siderolabs/iscsi-tools
         - siderolabs/new-extension
   EOF

   curl -X POST --data-binary @extensions.yaml https://factory.talos.dev/schematics
   ```

2. Update `talosImageURL` in `talconfig.yaml` with new schematic ID

3. Regenerate and upgrade:
   ```bash
   talhelper genconfig
   ./upgrade-talos.sh
   ```

## Modernization (Talos 1.12+)

This configuration has been modernized for Talos 1.12+:

âœ… **Strategic merge patches** instead of JSON patches
âœ… **Single-document YAML** configs
âœ… **Factory schematics** for extensions
âœ… **Automated upgrades** via script

### Key Changes from Talos 1.11

- JSON patches (`op: remove, path: /foo`) â†’ Strategic merge (`$$patch: delete`)
- Removed redundant feature flags (now defaults): `rbac`, `stableHostname`, `apidCheckExtKeyUsage`
- Added `grubUseUKICmdline: true` for new installations

## Important Notes

âš ï¸ **Never edit files in `clusterconfig/` directly** - they are generated by talhelper
âš ï¸ **Always upgrade via `talosctl upgrade`** - `apply-config` doesn't change the OS image
âš ï¸ **Use `$$patch` in patches** - single `$` will be interpreted as envsubst variable

## References

- [Talos Documentation](https://www.talos.dev/latest/)
- [talhelper Documentation](https://budimanjojo.github.io/talhelper/latest/)
- [Talos Image Factory](https://factory.talos.dev/)
- [Upgrade Guide](./UPGRADE.md)

## Getting Help

```bash
# Talos help
talosctl --help

# talhelper help
talhelper --help

# Check cluster health
kubectl get nodes
talosctl health --nodes 192.168.10.33,192.168.10.44,192.168.10.4
```
