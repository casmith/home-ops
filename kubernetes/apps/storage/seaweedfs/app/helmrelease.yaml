---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: seaweedfs
  namespace: storage
spec:
  interval: 30m
  chart:
    spec:
      chart: seaweedfs
      version: 4.0.401
      sourceRef:
        kind: HelmRepository
        name: seaweedfs
        namespace: storage
      interval: 30m
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    global:
      enableSecurity: true
      enableReplication: true
      replicationPlacement: "001"  # 0 DataCenter, 0 Rack, 1 copy (will be replicated across 3 volumes)

    master:
      enabled: true
      replicas: 3
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 256Mi
      data:
        type: "persistentVolumeClaim"
        size: "5Gi"
        storageClass: "longhorn"
      logs:
        type: "emptyDir"
      podAnnotations:
        reloader.stakater.com/auto: "true"

    volume:
      enabled: true
      replicas: 3
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi
      dataDirs:
        - name: data
          type: "persistentVolumeClaim"
          size: "100Gi"
          storageClass: "longhorn"
          maxVolumes: 0
      podAnnotations:
        reloader.stakater.com/auto: "true"

    filer:
      enabled: true
      replicas: 2
      s3:
        enabled: true
        port: 8333
        httpsPort: 0
        allowEmptyFolder: false
        domainName: ""
        enableAuth: true
        existingConfigSecret: seaweedfs-s3-secret
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 512Mi
      data:
        type: "persistentVolumeClaim"
        size: "10Gi"
        storageClass: "longhorn"
      logs:
        type: "emptyDir"
      podAnnotations:
        reloader.stakater.com/auto: "true"

    # Disable components we don't need
    cosi:
      enabled: false

    # Security contexts
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
