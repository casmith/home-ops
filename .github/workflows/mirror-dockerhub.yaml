---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Mirror Docker Hub Images"

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at 3am UTC
    - cron: "0 3 * * 0"

env:
  REGISTRY: ghcr.io

jobs:
  mirror:
    name: Mirror Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - source: docker.io/1password/connect-api
            target: ghcr.io/${{ github.repository_owner }}/mirror/1password-connect-api
          - source: docker.io/1password/connect-sync
            target: ghcr.io/${{ github.repository_owner }}/mirror/1password-connect-sync
          - source: docker.io/valkey/valkey
            target: ghcr.io/${{ github.repository_owner }}/mirror/valkey
          - source: docker.io/library/redis
            target: ghcr.io/${{ github.repository_owner }}/mirror/redis
          - source: docker.io/cloudflare/cloudflared
            target: ghcr.io/${{ github.repository_owner }}/mirror/cloudflared
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Get latest tag
        id: tag
        run: |
          # Get the latest tag from Docker Hub
          LATEST_TAG=$(skopeo list-tags docker://${{ matrix.source }} | jq -r '.Tags | map(select(test("^[0-9]+\\.[0-9]+"; "x"))) | sort_by(. | split(".") | map(tonumber? // 0)) | last // "latest"')
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            LATEST_TAG="latest"
          fi
          echo "tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $LATEST_TAG"

      - name: Mirror image
        run: |
          skopeo copy --all \
            docker://${{ matrix.source }}:${{ steps.tag.outputs.tag }} \
            docker://${{ matrix.target }}:${{ steps.tag.outputs.tag }}

          # Also tag as latest
          skopeo copy --all \
            docker://${{ matrix.source }}:${{ steps.tag.outputs.tag }} \
            docker://${{ matrix.target }}:latest
